version: '3.5'

x-styx-db: &styx-db
  image: styx/db
  build: ./db
  volumes:
    - "./db/init.sh:/docker-entrypoint-initdb.d/init.sh"
    - "./db/schema.sql:/opt/server/schema.sql"
    - "./db/server:/opt/server/"
    - "./shared:/opt/server/src/shared"      
    - "/opt/server/node_modules"    
  expose: 
    - "5432"
  environment:
    - NODE_ENV=development    
    - PGUSER=styx_admin
    - PGDATABASE=styx_db

x-styx-consul: &styx-consul 
  image: "consul:latest"
  command: agent

x-styx-consul-server: &styx-consul-server 
  <<: *styx-consul
  image: styx/consul-server
  volumes:
    - "./consul/server/config:/consul/config"
  depends_on:
    - styx-consul-agent-1
    - styx-consul-agent-2
    - styx-consul-agent-3                  
  
services:

  styx-master:
    container_name: styx-master
    build: ./consul/control
    volumes: 
      - "./consul/control/config:/consul/config"
      - "./consul/control/server:/opt/server/"
      - "./shared:/opt/server/src/shared"
      - "/opt/server/node_modules"
    ports: 
      - "8500:8500"
      - "7000:80"
    depends_on:
      - styx-consul-server-1
      - styx-consul-server-2
      - styx-consul-server-3
    environment:
      - NODE_ENV=development
    command: agent

  styx-consul-server-1: 
    <<: *styx-consul-server    
    container_name: styx-consul-server-1
    
  styx-consul-server-2:
    <<: *styx-consul-server
    container_name: styx-consul-server-2

  styx-consul-server-3:
    <<: *styx-consul-server
    container_name: styx-consul-server-3

  styx-consul-agent-1: 
    <<: *styx-consul
    container_name: styx-consul-agent-1
    volumes:
      - "./consul/agent/config/db-1.json:/consul/config/db.json"
    depends_on:
      - styx-db-1

  styx-consul-agent-2:
    <<: *styx-consul
    container_name: styx-consul-agent-2
    volumes:
      - "./consul/agent/config/db-2.json:/consul/config/db.json"    
    depends_on:
      - styx-db-2      

  styx-consul-agent-3:
    <<: *styx-consul
    container_name: styx-consul-agent-3
    volumes:
      - "./consul/agent/config/db-3.json:/consul/config/db.json"    
    depends_on:
      - styx-db-3

  styx-consul-agent-4:
    <<: *styx-consul
    container_name: styx-consul-agent-4
    volumes:
      - "./consul/agent/config/db-4.json:/consul/config/db.json"    
    depends_on:
      - styx-db-4

  styx-consul-agent-5:
    <<: *styx-consul
    container_name: styx-consul-agent-5
    volumes:
      - "./consul/agent/config/db-5.json:/consul/config/db.json"
    depends_on:
      - styx-db-5

  styx-db-1:
    <<: *styx-db
    container_name: styx-db-1
    ports:
      - "5441:5432"              

  styx-db-2: 
    <<: *styx-db
    container_name: styx-db-2
    ports:
      - "5442:5432"                  

  styx-db-3: 
    <<: *styx-db
    container_name: styx-db-3
    ports:
      - "5443:5432"              

  styx-db-4: 
    <<: *styx-db
    container_name: styx-db-4
    ports:
      - "5444:5432"              

  styx-db-5: 
    <<: *styx-db
    container_name: styx-db-5    
    ports:
      - "5445:5432"                  